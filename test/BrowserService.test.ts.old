import { describe, expect, it, beforeEach } from "@effect/vitest"
import { vi } from "vitest"
import { Effect } from "effect"
import type { Browser, BrowserContext, Page } from "playwright"
import { chromium } from "playwright"
import { GoogleGenerativeAI } from "@google/generative-ai"
import { BrowserService, BrowserServiceLive } from "../src/services/BrowserService"

vi.mock("playwright", async () => {
  const actual = await vi.importActual<typeof import("playwright")>("playwright")
  return {
    ...actual,
    chromium: {
      launch: vi.fn(),
    },
  }
})

vi.mock("@google/generative-ai", () => ({
  GoogleGenerativeAI: vi.fn(),
}))

const mockPage = {
  goto: vi.fn(),
  screenshot: vi.fn(),
  close: vi.fn(),
} as unknown as Page

const mockContext = {
  newPage: vi.fn(),
  close: vi.fn(),
} as unknown as BrowserContext

const mockBrowser = {
  newContext: vi.fn(),
  close: vi.fn(),
} as unknown as Browser

describe("BrowserService", () => {
  beforeEach(async () => {
    vi.clearAllMocks()
    process.env.GEMINI_API_KEY = "test-api-key"
  })

  describe("browser lifecycle", () => {
    it.effect("should launch browser, create context, and create page", () =>
      Effect.gen(function* () {
        vi.mocked(chromium.launch).mockResolvedValue(mockBrowser)
        vi.mocked(mockBrowser.newContext).mockResolvedValue(mockContext)
        vi.mocked(mockContext.newPage).mockResolvedValue(mockPage)
        vi.mocked(GoogleGenerativeAI).mockImplementation(
          () =>
            ({
              getGenerativeModel: vi.fn().mockReturnValue({
                generateContent: vi.fn(),
              }),
            }) as any
        )

        const program = Effect.gen(function* () {
          const browser = yield* BrowserService
          expect(browser).toBeDefined()
        })

        yield* program.pipe(Effect.provide(BrowserServiceLive))

        expect(chromium.launch).toHaveBeenCalledWith({ headless: false })
        expect(mockBrowser.newContext).toHaveBeenCalled()
        expect(mockContext.newPage).toHaveBeenCalled()
      })
    )

    it.effect("should fail when browser launch fails", () =>
      Effect.gen(function* () {
        vi.mocked(chromium.launch).mockRejectedValue(new Error("Launch failed"))

        const program = Effect.gen(function* () {
          yield* BrowserService
        })

        const result = yield* program.pipe(
          Effect.provide(BrowserServiceLive),
          Effect.flip
        )

        expect(result.message).toContain("Browser launch failed")
      })
    )

    it.effect("should fail when context creation fails", () =>
      Effect.gen(function* () {
        vi.mocked(chromium.launch).mockResolvedValue(mockBrowser)
        vi.mocked(mockBrowser.newContext).mockRejectedValue(
          new Error("Context failed")
        )

        const program = Effect.gen(function* () {
          yield* BrowserService
        })

        const result = yield* program.pipe(
          Effect.provide(BrowserServiceLive),
          Effect.flip
        )

        expect(result.message).toContain("Browser context creation failed")
      })
    )

    it.effect("should fail when page creation fails", () =>
      Effect.gen(function* () {
        vi.mocked(chromium.launch).mockResolvedValue(mockBrowser)
        vi.mocked(mockBrowser.newContext).mockResolvedValue(mockContext)
        vi.mocked(mockContext.newPage).mockRejectedValue(new Error("Page failed"))

        const program = Effect.gen(function* () {
          yield* BrowserService
        })

        const result = yield* program.pipe(
          Effect.provide(BrowserServiceLive),
          Effect.flip
        )

        expect(result.message).toContain("Page creation failed")
      })
    )

    it.effect("should close browser on scope exit", () =>
      Effect.gen(function* () {
        vi.mocked(chromium.launch).mockResolvedValue(mockBrowser)
        vi.mocked(mockBrowser.newContext).mockResolvedValue(mockContext)
        vi.mocked(mockContext.newPage).mockResolvedValue(mockPage)
        vi.mocked(mockBrowser.close).mockResolvedValue()
        vi.mocked(GoogleGenerativeAI).mockImplementation(
          () =>
            ({
              getGenerativeModel: vi.fn().mockReturnValue({
                generateContent: vi.fn(),
              }),
            }) as any
        )

        const program = Effect.gen(function* () {
          yield* BrowserService
        })

        yield* program.pipe(Effect.provide(BrowserServiceLive))

        expect(mockBrowser.close).toHaveBeenCalled()
      })
    )

    it.effect("should handle browser close failure gracefully", () =>
      Effect.gen(function* () {
        vi.mocked(chromium.launch).mockResolvedValue(mockBrowser)
        vi.mocked(mockBrowser.newContext).mockResolvedValue(mockContext)
        vi.mocked(mockContext.newPage).mockResolvedValue(mockPage)
        vi.mocked(mockBrowser.close).mockRejectedValue(
          new Error("Close failed")
        )
        vi.mocked(GoogleGenerativeAI).mockImplementation(
          () =>
            ({
              getGenerativeModel: vi.fn().mockReturnValue({
                generateContent: vi.fn(),
              }),
            }) as any
        )

        const program = Effect.gen(function* () {
          yield* BrowserService
        })

        yield* program.pipe(Effect.provide(BrowserServiceLive))
      })
    )
  })

  describe("navigate", () => {
    it.effect("should navigate to URL successfully", () =>
      Effect.gen(function* () {
        vi.mocked(chromium.launch).mockResolvedValue(mockBrowser)
        vi.mocked(mockBrowser.newContext).mockResolvedValue(mockContext)
        vi.mocked(mockContext.newPage).mockResolvedValue(mockPage)
        vi.mocked(mockPage.goto).mockResolvedValue(null)
        vi.mocked(GoogleGenerativeAI).mockImplementation(
          () =>
            ({
              getGenerativeModel: vi.fn().mockReturnValue({
                generateContent: vi.fn(),
              }),
            }) as any
        )

        const program = Effect.gen(function* () {
          const browser = yield* BrowserService
          yield* browser.navigate("https://example.com")
        })

        yield* program.pipe(Effect.provide(BrowserServiceLive))

        expect(mockPage.goto).toHaveBeenCalledWith("https://example.com")
      })
    )

    it.effect("should fail when navigation fails", () =>
      Effect.gen(function* () {
        vi.mocked(chromium.launch).mockResolvedValue(mockBrowser)
        vi.mocked(mockBrowser.newContext).mockResolvedValue(mockContext)
        vi.mocked(mockContext.newPage).mockResolvedValue(mockPage)
        vi.mocked(mockPage.goto).mockRejectedValue(
          new Error("Navigation error")
        )
        vi.mocked(GoogleGenerativeAI).mockImplementation(
          () =>
            ({
              getGenerativeModel: vi.fn().mockReturnValue({
                generateContent: vi.fn(),
              }),
            }) as any
        )

        const program = Effect.gen(function* () {
          const browser = yield* BrowserService
          yield* browser.navigate("https://invalid.com")
        })

        const result = yield* program.pipe(
          Effect.provide(BrowserServiceLive),
          Effect.flip
        )

        expect(result.message).toContain("Navigation failed")
      })
    )

    it.effect("should handle multiple navigation calls", () =>
      Effect.gen(function* () {
        vi.mocked(chromium.launch).mockResolvedValue(mockBrowser)
        vi.mocked(mockBrowser.newContext).mockResolvedValue(mockContext)
        vi.mocked(mockContext.newPage).mockResolvedValue(mockPage)
        vi.mocked(mockPage.goto).mockResolvedValue(null)
        vi.mocked(GoogleGenerativeAI).mockImplementation(
          () =>
            ({
              getGenerativeModel: vi.fn().mockReturnValue({
                generateContent: vi.fn(),
              }),
            }) as any
        )

        const program = Effect.gen(function* () {
          const browser = yield* BrowserService
          yield* browser.navigate("https://example1.com")
          yield* browser.navigate("https://example2.com")
        })

        yield* program.pipe(Effect.provide(BrowserServiceLive))

        expect(mockPage.goto).toHaveBeenCalledTimes(2)
        expect(mockPage.goto).toHaveBeenCalledWith("https://example1.com")
        expect(mockPage.goto).toHaveBeenCalledWith("https://example2.com")
      })
    )
  })

  describe("act", () => {
    it.effect("should capture screenshot and call Gemini API", () =>
      Effect.gen(function* () {
        const mockScreenshot = Buffer.from("test-screenshot")
        const mockGenerateContent = vi.fn().mockResolvedValue({
          response: {
            text: vi.fn().mockReturnValue("Action result"),
          },
        })

        vi.mocked(chromium.launch).mockResolvedValue(mockBrowser)
        vi.mocked(mockBrowser.newContext).mockResolvedValue(mockContext)
        vi.mocked(mockContext.newPage).mockResolvedValue(mockPage)
        vi.mocked(mockPage.screenshot).mockResolvedValue(mockScreenshot)

        vi.mocked(GoogleGenerativeAI).mockImplementation(
          () =>
            ({
              getGenerativeModel: vi.fn().mockReturnValue({
                generateContent: mockGenerateContent,
              }),
            }) as any
        )

        const program = Effect.gen(function* () {
          const browser = yield* BrowserService
          const result = yield* browser.act("Click the button")
          expect(result).toBe("Action result")
        })

        yield* program.pipe(Effect.provide(BrowserServiceLive))

        expect(mockPage.screenshot).toHaveBeenCalled()
        expect(mockGenerateContent).toHaveBeenCalledWith([
          "Act on this page: Click the button",
          {
            inlineData: {
              data: mockScreenshot.toString("base64"),
              mimeType: "image/png",
            },
          },
        ])
      })
    )

    it.effect("should fail when screenshot fails", () =>
      Effect.gen(function* () {
        vi.mocked(chromium.launch).mockResolvedValue(mockBrowser)
        vi.mocked(mockBrowser.newContext).mockResolvedValue(mockContext)
        vi.mocked(mockContext.newPage).mockResolvedValue(mockPage)
        vi.mocked(mockPage.screenshot).mockRejectedValue(
          new Error("Screenshot failed")
        )
        vi.mocked(GoogleGenerativeAI).mockImplementation(
          () =>
            ({
              getGenerativeModel: vi.fn().mockReturnValue({
                generateContent: vi.fn(),
              }),
            }) as any
        )

        const program = Effect.gen(function* () {
          const browser = yield* BrowserService
          yield* browser.act("Click the button")
        })

        const result = yield* program.pipe(
          Effect.provide(BrowserServiceLive),
          Effect.flip
        )

        expect(result.message).toContain("Browser action failed")
      })
    )

    it.effect("should fail when Gemini API fails", () =>
      Effect.gen(function* () {
        const mockScreenshot = Buffer.from("test-screenshot")
        const mockGenerateContent = vi
          .fn()
          .mockRejectedValue(new Error("API error"))

        vi.mocked(chromium.launch).mockResolvedValue(mockBrowser)
        vi.mocked(mockBrowser.newContext).mockResolvedValue(mockContext)
        vi.mocked(mockContext.newPage).mockResolvedValue(mockPage)
        vi.mocked(mockPage.screenshot).mockResolvedValue(mockScreenshot)

        vi.mocked(GoogleGenerativeAI).mockImplementation(
          () =>
            ({
              getGenerativeModel: vi.fn().mockReturnValue({
                generateContent: mockGenerateContent,
              }),
            }) as any
        )

        const program = Effect.gen(function* () {
          const browser = yield* BrowserService
          yield* browser.act("Click the button")
        })

        const result = yield* program.pipe(
          Effect.provide(BrowserServiceLive),
          Effect.flip
        )

        expect(result.message).toContain("Browser action failed")
      })
    )

    it.effect("should handle multiple act calls", () =>
      Effect.gen(function* () {
        const mockScreenshot = Buffer.from("test-screenshot")
        const mockGenerateContent = vi
          .fn()
          .mockResolvedValueOnce({
            response: {
              text: vi.fn().mockReturnValue("First result"),
            },
          })
          .mockResolvedValueOnce({
            response: {
              text: vi.fn().mockReturnValue("Second result"),
            },
          })

        vi.mocked(chromium.launch).mockResolvedValue(mockBrowser)
        vi.mocked(mockBrowser.newContext).mockResolvedValue(mockContext)
        vi.mocked(mockContext.newPage).mockResolvedValue(mockPage)
        vi.mocked(mockPage.screenshot).mockResolvedValue(mockScreenshot)

        vi.mocked(GoogleGenerativeAI).mockImplementation(
          () =>
            ({
              getGenerativeModel: vi.fn().mockReturnValue({
                generateContent: mockGenerateContent,
              }),
            }) as any
        )

        const program = Effect.gen(function* () {
          const browser = yield* BrowserService
          const result1 = yield* browser.act("First action")
          const result2 = yield* browser.act("Second action")

          expect(result1).toBe("First result")
          expect(result2).toBe("Second result")
        })

        yield* program.pipe(Effect.provide(BrowserServiceLive))

        expect(mockPage.screenshot).toHaveBeenCalledTimes(2)
        expect(mockGenerateContent).toHaveBeenCalledTimes(2)
      })
    )
  })

  describe("Layer behavior", () => {
    it.effect("should create independent instances per scope", () =>
      Effect.gen(function* () {
        vi.mocked(chromium.launch).mockResolvedValue(mockBrowser)
        vi.mocked(mockBrowser.newContext).mockResolvedValue(mockContext)
        vi.mocked(mockContext.newPage).mockResolvedValue(mockPage)
        vi.mocked(GoogleGenerativeAI).mockImplementation(
          () =>
            ({
              getGenerativeModel: vi.fn().mockReturnValue({
                generateContent: vi.fn(),
              }),
            }) as any
        )

        const program1 = Effect.gen(function* () {
          yield* BrowserService
        }).pipe(Effect.provide(BrowserServiceLive))

        const program2 = Effect.gen(function* () {
          yield* BrowserService
        }).pipe(Effect.provide(BrowserServiceLive))

        yield* program1
        yield* program2

        expect(chromium.launch).toHaveBeenCalledTimes(2)
      })
    )

    it.effect("should share instance within same scope", () =>
      Effect.gen(function* () {
        vi.mocked(chromium.launch).mockResolvedValue(mockBrowser)
        vi.mocked(mockBrowser.newContext).mockResolvedValue(mockContext)
        vi.mocked(mockContext.newPage).mockResolvedValue(mockPage)
        vi.mocked(mockPage.goto).mockResolvedValue(null)
        vi.mocked(GoogleGenerativeAI).mockImplementation(
          () =>
            ({
              getGenerativeModel: vi.fn().mockReturnValue({
                generateContent: vi.fn(),
              }),
            }) as any
        )

        const program = Effect.gen(function* () {
          const browser1 = yield* BrowserService
          const browser2 = yield* BrowserService

          yield* browser1.navigate("https://example1.com")
          yield* browser2.navigate("https://example2.com")
        })

        yield* program.pipe(Effect.provide(BrowserServiceLive))

        expect(chromium.launch).toHaveBeenCalledTimes(1)
        expect(mockPage.goto).toHaveBeenCalledTimes(2)
      })
    )
  })

  describe("edge cases", () => {
    it.effect("should handle empty instruction string", () =>
      Effect.gen(function* () {
        const mockScreenshot = Buffer.from("test-screenshot")
        const mockGenerateContent = vi.fn().mockResolvedValue({
          response: {
            text: vi.fn().mockReturnValue("Empty result"),
          },
        })

        vi.mocked(chromium.launch).mockResolvedValue(mockBrowser)
        vi.mocked(mockBrowser.newContext).mockResolvedValue(mockContext)
        vi.mocked(mockContext.newPage).mockResolvedValue(mockPage)
        vi.mocked(mockPage.screenshot).mockResolvedValue(mockScreenshot)

        vi.mocked(GoogleGenerativeAI).mockImplementation(
          () =>
            ({
              getGenerativeModel: vi.fn().mockReturnValue({
                generateContent: mockGenerateContent,
              }),
            }) as any
        )

        const program = Effect.gen(function* () {
          const browser = yield* BrowserService
          const result = yield* browser.act("")
          expect(result).toBe("Empty result")
        })

        yield* program.pipe(Effect.provide(BrowserServiceLive))

        expect(mockGenerateContent).toHaveBeenCalledWith([
          "Act on this page: ",
          expect.any(Object),
        ])
      })
    )

    it.effect("should handle special characters in URL", () =>
      Effect.gen(function* () {
        vi.mocked(chromium.launch).mockResolvedValue(mockBrowser)
        vi.mocked(mockBrowser.newContext).mockResolvedValue(mockContext)
        vi.mocked(mockContext.newPage).mockResolvedValue(mockPage)
        vi.mocked(mockPage.goto).mockResolvedValue(null)
        vi.mocked(GoogleGenerativeAI).mockImplementation(
          () =>
            ({
              getGenerativeModel: vi.fn().mockReturnValue({
                generateContent: vi.fn(),
              }),
            }) as any
        )

        const program = Effect.gen(function* () {
          const browser = yield* BrowserService
          yield* browser.navigate("https://example.com/path?query=value&foo=bar")
        })

        yield* program.pipe(Effect.provide(BrowserServiceLive))

        expect(mockPage.goto).toHaveBeenCalledWith(
          "https://example.com/path?query=value&foo=bar"
        )
      })
    )

    it.effect("should handle large screenshot buffer", () =>
      Effect.gen(function* () {
        const largeScreenshot = Buffer.alloc(1024 * 1024)
        const mockGenerateContent = vi.fn().mockResolvedValue({
          response: {
            text: vi.fn().mockReturnValue("Large result"),
          },
        })

        vi.mocked(chromium.launch).mockResolvedValue(mockBrowser)
        vi.mocked(mockBrowser.newContext).mockResolvedValue(mockContext)
        vi.mocked(mockContext.newPage).mockResolvedValue(mockPage)
        vi.mocked(mockPage.screenshot).mockResolvedValue(largeScreenshot)

        vi.mocked(GoogleGenerativeAI).mockImplementation(
          () =>
            ({
              getGenerativeModel: vi.fn().mockReturnValue({
                generateContent: mockGenerateContent,
              }),
            }) as any
        )

        const program = Effect.gen(function* () {
          const browser = yield* BrowserService
          const result = yield* browser.act("Test large screenshot")
          expect(result).toBe("Large result")
        })

        yield* program.pipe(Effect.provide(BrowserServiceLive))

        expect(mockGenerateContent).toHaveBeenCalledWith([
          "Act on this page: Test large screenshot",
          {
            inlineData: {
              data: largeScreenshot.toString("base64"),
              mimeType: "image/png",
            },
          },
        ])
      })
    )
  })
})
